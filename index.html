<head>
  <script src="https://aframe.io/releases/0.8.0/aframe.min.js"></script>
  <!--script src="https://jeromeetienne.github.io/AR.js/aframe/build/aframe-ar.js"></script-->
  <script src="./vendor/aframe-ar.js"></script>
  <script src="./vendor/STLLoader.js"></script>
  
  <!-- polyfill -->
	<script src="./MIDI/inc/shim/Base64.js" type="text/javascript"></script>
	<script src="./MIDI/inc/shim/Base64binary.js" type="text/javascript"></script>
	<script src="./MIDI/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
	<!-- midi.js package -->
	<script src="./MIDI/js/midi/audioDetect.js" type="text/javascript"></script>
	<script src="./MIDI/js/midi/gm.js" type="text/javascript"></script>
	<script src="./MIDI/js/midi/loader.js" type="text/javascript"></script>
	<script src="./MIDI/js/midi/plugin.audiotag.js" type="text/javascript"></script>
	<script src="./MIDI/js/midi/plugin.webaudio.js" type="text/javascript"></script>
	<script src="./MIDI/js/midi/plugin.webmidi.js" type="text/javascript"></script>
	<!-- utils -->
	<script src="./MIDI/js/util/dom_request_xhr.js" type="text/javascript"></script>
	<script src="./MIDI/js/util/dom_request_script.js" type="text/javascript"></script>

</head>
<body style='margin : 0px; overflow: hidden;'>
  <script>
    AFRAME.registerComponent('sound_note', {
    schema: {
      instrument: {type: 'string', default: 'acoustic_grand_piano'},
      message: {type: 'string', default: 'Hello, World!'}
    },

      init: function () {
        var el = this.el;
        
        var onScreen = false;

        var delay = 0; // play one note every quarter second
        var do3 = 60;
        var re3 = 62;
        var mi3 = 64;
        var fa3 = 65;
        var sol3 = 67;
        var la3 = 69;
        var si3 = 71;
        var do4 = 72; // the MIDI note
        var re4 = 74;
        var mi4 = 76;
        var fa4 = 77;
        var sol4 = 79;
        var la4 = 81;
        var si4 = 83;
        var do5 = 84;
        var velocity = 127;
        var instrument_name = this.data.instrument;

        
        MIDI.loadPlugin({
        soundfontUrl: "https://gleitz.github.io/midi-js-soundfonts/FluidR3_GM/",
        instrument: instrument_name,
        onprogress: function(state, progress) {
          console.log(state, progress);
        },
        onsuccess: function() {
          instrument_number = MIDI.GM.byName[instrument_name].number;
          /*var delay = 0; // play one note every quarter second
          //DO  MAYOR
          var do3 = 60;
          var re3 = 62;
          var mi3 = 64;
          var fa3 = 65;
          var sol3 = 67;
          var la3 = 69;
          var si3 = 71;
          var do4 = 72; // the MIDI note
          var re4 = 74;
          var mi4 = 76;
          var fa4 = 77;
          var sol4 = 79;
          var la4 = 81;
          var si4 = 83;
          var do5 = 84;
          var velocity = 127; // how hard the note hits*/
        }
      });
      
      el.parentElement.addEventListener('markerFound', function () { 
        if(onScreen == false){
          onScreen = true;
          MIDI.programChange(0, instrument_number);
          MIDI.setVolume(0, 127);
          MIDI.noteOn(0, do4, velocity, 0);
          MIDI.noteOff(0, do4, 1);
        
        }
      }); 

      el.parentElement.addEventListener('markerLost', function () { 
        onScreen = false;
      }); 

      
      },

      update: function () {
      }
    });
    
  </script>

  <a-scene embedded arjs='sourceType: webcam;'>
    <a-marker type='pattern' url='./patterns/pattern-marker.patt' emitevents='true'>
      <a-entity class="note" position='0 0.5 0' material="color: red">
          <a-animation attribute="rotation"
               easing="linear"
               dur="10000"
               fill="forwards"
               to="0 360 0"
               repeat="indefinite"></a-animation>
      </a-entity>
      <a-entity sound_note="instrument: accordion"></a-entity>
    </a-marker>

    <a-marker type='pattern' url='./patterns/pattern-marker-2.patt'>
      <a-box position='0 0.5 0' material='color: blue;'></a-box>
    </a-marker>

    <!-- add a simple camera -->
    <a-entity camera></a-entity>

    <script src="./js/index.js"></script>
  </a-scene> 
</body>
